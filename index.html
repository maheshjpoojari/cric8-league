<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cric-8 League Pro Engine</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #0f172a; color: white; text-align: center; padding: 10px; margin: 0; touch-action: manipulation; }
        .hidden { display: none !important; }
        .screen { max-width: 500px; margin: auto; padding-bottom: 50px; }
        input { padding: 12px; margin: 5px; width: 90%; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; font-size: 16px; }
        .score-card { background: #1e293b; padding: 15px; border-radius: 15px; margin-bottom: 10px; border: 1px solid #334155; }
        .score-big { font-size: 4.5rem; font-weight: 800; color: #38bdf8; line-height: 1; margin: 5px 0; }
        .death-active { border: 2px solid #ef4444; background: #2b0a0a; animation: glow 1.5s infinite alternate; }
        @keyframes glow { from { box-shadow: 0 0 5px #ef4444; } to { box-shadow: 0 0 20px #ef4444; } }
        .target-bar { background: #064e3b; color: #34d399; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: bold; font-size: 1.1rem; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 1.1rem; cursor: pointer; -webkit-tap-highlight-color: transparent; }
        .btn-run { background: #334155; color: white; }
        .btn-wkt { background: #ef4444; color: white; grid-column: span 3; }
        .btn-man { background: #7f1d1d; color: #fca5a5; grid-column: span 3; border: 1px solid #ef4444; }
        .btn-xtra { background: #f59e0b; color: black; }
        .btn-undo { background: #475569; color: white; grid-column: span 3; margin-top: 10px; }
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); display: flex; flex-direction: column; justify-content: flex-start; align-items: center; z-index: 200; overflow-y: auto; padding: 20px; }
        .sel-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 95%; max-width: 400px; padding: 10px; }
        .sel-btn { background: #38bdf8; color: #0f172a; padding: 15px; border-radius: 8px; font-weight: bold; }
        .active-bat { color: #fbbf24; text-decoration: underline; font-weight: 900; transform: scale(1.1); display: inline-block; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.75rem; background: #1e293b; border-radius: 10px; overflow: hidden; }
        th { background: #334155; color: #38bdf8; padding: 6px; text-align: center; }
        td { padding: 8px 4px; border-bottom: 1px solid #334155; text-align: center; }
        .text-left { text-align: left; padding-left: 10px; }
    </style>
</head>
<body>

    <div id="overlaySelect" class="overlay hidden">
        <h2 id="selTitle" style="color:#38bdf8; margin-top: 40px;">Select Player</h2>
        <div id="selGrid" class="sel-grid"></div>
    </div>

    <div id="overlayInnings" class="overlay hidden">
        <h2 style="color:#fbbf24; margin-top: 80px;">INNINGS COMPLETE</h2>
        <h1 id="innScore" style="font-size: 4rem; margin: 0; color: white;">0</h1>
        <h3 id="innTarget" style="color:#34d399;"></h3>
        <button onclick="startSecondInnings()" style="background:#38bdf8; color:black; padding:20px; width:80%;">START 2ND INNINGS</button>
    </div>

    <div id="overlaySummary" class="overlay hidden">
        <h2 id="finalResultText" style="color:#38bdf8; margin-top: 20px;">MATCH OVER</h2>
        <h3 id="finalScoreText" style="color:#cbd5e1; margin-bottom: 10px;"></h3>
        <button onclick="shareResult()" style="background:#10b981; color:white; padding:12px; width:90%; border-radius: 8px; font-weight: bold;">ðŸ“‹ COPY FULL SCORECARD</button>
        <div style="width: 100%; max-width: 550px;">
            <table id="summaryTable">
                <thead><tr><th class="text-left">Player</th><th>R</th><th>B</th><th>SR</th><th>W</th></tr></thead>
                <tbody id="summaryBody"></tbody>
            </table>
        </div>
        <button onclick="location.reload()" style="background:#ef4444; color:white; padding:15px; width:90%; margin: 20px 0; border-radius: 8px;">NEW MATCH</button>
    </div>

    <div id="screenSetup" class="screen">
        <h1 style="color:#38bdf8">Cric-8 League</h1>
        <input id="team1Name" placeholder="Team 1 Name">
        <input id="team2Name" placeholder="Team 2 Name">
        <div style="display:flex; gap:5px;"><div id="inputsT1" style="width:50%"></div><div id="inputsT2" style="width:50%"></div></div>
        <button onclick="initMatch()" style="background:#10b981; color:white; width:95%; margin-top:20px; padding: 15px;">START MATCH</button>
    </div>

    <div id="screenGame" class="screen hidden">
        <div id="targetBox" class="target-bar hidden">Target: <span id="targetVal">0</span> | Need: <span id="needVal">0</span></div>
        <div style="display:flex; justify-content:space-between; padding: 0 10px;">
            <div id="batTeamName" style="color:#38bdf8; font-weight:bold;">-</div>
            <div style="font-size:0.9rem;">Bowler: <span id="bowlerName" style="color:#fbbf24; font-weight:bold;">-</span></div>
        </div>
        <div style="display:flex; justify-content:space-around; background:#1e293b; padding:15px; border-radius:15px; margin: 10px 0; border: 1px solid #334155;">
            <div id="bat1" onclick="setStrike(0)">-</div>
            <div id="bat2" onclick="setStrike(1)">-</div>
        </div>
        <div id="scoreCard" class="score-card">
            <div id="scoreDisplay" class="score-big">0</div>
            <div style="display: flex; justify-content: space-between; padding: 0 20px;">
                <span>Overs: <span id="overDisplay">0.0</span> / 8.0</span>
                <span>Wkts: <span id="wktDisplay" style="color: #ef4444;">0</span></span>
            </div>
            <div id="dotTracker" style="margin-top:10px; font-size:1.5rem; letter-spacing: 5px;">âšª âšª âšª</div>
        </div>
        <div class="grid">
            <button class="btn-run" onclick="handleInput(0)">0</button>
            <button class="btn-run" onclick="handleInput(1)">1</button>
            <button class="btn-run" onclick="handleInput(2)">2</button>
            <button class="btn-run" onclick="handleInput(3)">3</button>
            <button class="btn-run" onclick="handleInput(4)">4</button>
            <button class="btn-run" onclick="handleInput(6)">6</button>
            <button class="btn-xtra" onclick="handleInput('WD')">WD +2</button>
            <button class="btn-xtra" onclick="handleInput('NB')">NB +2</button>
            <button class="btn-wkt" onclick="handleInput('W')">WICKET (-5)</button>
            <button class="btn-man" onclick="handleInput('M')">MANKAD (-5)</button>
            <button class="btn-undo" onclick="undo()">UNDO</button>
        </div>
    </div>

    <script>
        let teams = { t1: {name:"", p:[]}, t2: {name:"", p:[]} };
        let match = { inning: 1, battingTeamId: 't1', bowlingTeamId: 't2', target: null, history: [], firstScore: 0 };
        let state = { score: 0, balls: 0, wickets: 0, dots: 0, strikerIdx: 0, currentPair: [], currentBowler: null, stats: {} };

        for(let i=0; i<10; i++) {
            document.getElementById('inputsT1').innerHTML += `<input id="t1p${i}" placeholder="P${i+1}">`;
            document.getElementById('inputsT2').innerHTML += `<input id="t2p${i}" placeholder="P${i+1}">`;
        }

        function initMatch() {
            teams.t1.name = document.getElementById('team1Name').value || "Team 1";
            teams.t2.name = document.getElementById('team2Name').value || "Team 2";
            for(let i=0; i<10; i++) {
                let n1 = document.getElementById(`t1p${i}`).value || `T1-P${i+1}`;
                let n2 = document.getElementById(`t2p${i}`).value || `T2-P${i+1}`;
                teams.t1.p.push({name: n1, team:'t1', batted:false, overs:0});
                teams.t2.p.push({name: n2, team:'t2', batted:false, overs:0});
                state.stats[n1] = {r:0, b:0, w:0}; state.stats[n2] = {r:0, b:0, w:0};
            }
            document.getElementById('screenSetup').classList.add('hidden');
            document.getElementById('screenGame').classList.remove('hidden');
            startInningsLogic();
        }

        function startInningsLogic() {
            state.score = 0; state.balls = 0; state.wickets = 0; state.dots = 0;
            state.strikerIdx = 0; state.currentPair = []; state.currentBowler = null;
            document.getElementById('batTeamName').innerText = teams[match.battingTeamId].name;
            if(match.inning === 2) {
                document.getElementById('targetBox').classList.remove('hidden');
                document.getElementById('targetVal').innerText = match.target;
            }
            triggerSelectionProcess();
        }

        function triggerSelectionProcess() {
            if (state.currentPair.length < 2) pickBatters();
            else if (state.currentBowler === null) pickBowler();
            else updateUI();
        }

        function pickBatters() {
            const roster = teams[match.battingTeamId].p.filter(p => !p.batted);
            if (roster.length === 0) { endInnings(); return; }
            showOverlay("Select Striker", roster, (p1) => {
                p1.batted = true;
                const rem = roster.filter(x => x.name !== p1.name);
                if (rem.length === 0) { state.currentPair = [p1]; triggerSelectionProcess(); }
                else {
                    showOverlay("Select Non-Striker", rem, (p2) => {
                        p2.batted = true; state.currentPair = [p1, p2]; triggerSelectionProcess();
                    });
                }
            });
        }

        function pickBowler() {
            const roster = teams[match.bowlingTeamId].p.filter(p => p.overs < 1);
            showOverlay("Select Bowler", roster, (p) => { state.currentBowler = p; triggerSelectionProcess(); });
        }

        function showOverlay(title, list, callback) {
            document.getElementById('selTitle').innerText = title;
            const grid = document.getElementById('selGrid'); grid.innerHTML = "";
            list.forEach(p => {
                const btn = document.createElement('button'); btn.className = 'sel-btn';
                btn.innerText = p.name; btn.onclick = () => { document.getElementById('overlaySelect').classList.add('hidden'); callback(p); };
                grid.appendChild(btn);
            });
            document.getElementById('overlaySelect').classList.remove('hidden');
        }

        function handleInput(type) {
            if(!state.currentBowler || state.currentPair.length === 0) return;
            match.history.push(JSON.parse(JSON.stringify(state)));
            const striker = state.currentPair[state.strikerIdx];
            const nonStr = state.currentPair[state.strikerIdx === 0 ? 1 : 0];
            const isDeath = state.balls >= 42; const prevB = state.balls;

            if (typeof type === 'number') {
                state.score += type; state.stats[striker.name].r += type; state.stats[striker.name].b += 1; state.balls += 1;
                if(type === 0) state.dots++; else { state.dots = 0; if(type % 2 !== 0) swapStrike(); }
            } else if (type === 'W') {
                state.score -= 5; state.stats[striker.name].r -= 5; state.stats[striker.name].b += 1;
                state.stats[state.currentBowler.name].w += 1; state.wickets += 1; state.balls += 1; state.dots = 0;
            } else if (type === 'M') {
                state.score -= 5; if(nonStr) state.stats[nonStr.name].r -= 5; state.wickets += 1;
            } else if (type === 'WD' || type === 'NB') {
                state.score += 2; state.dots = 0; if (!isDeath) { state.balls += 1; state.stats[striker.name].b += 1; }
            }

            if (state.dots >= 3) {
                setTimeout(() => { alert("3 Dots! -5 Penalty."); }, 50);
                state.score -= 5; state.stats[striker.name].r -= 5; state.dots = 0;
            }

            if (state.balls > prevB && state.balls % 6 === 0) {
                swapStrike(); state.currentBowler.overs += 1; state.currentBowler = null;
                if (state.balls >= 48) { updateUI(); setTimeout(() => endInnings(), 100); return; }
                if (state.balls % 12 === 0) state.currentPair = [];
                triggerSelectionProcess();
            } else updateUI();
        }

        function updateUI() {
            document.getElementById('scoreDisplay').innerText = state.score;
            document.getElementById('overDisplay').innerText = `${Math.floor(state.balls/6)}.${state.balls%6}`;
            document.getElementById('wktDisplay').innerText = state.wickets;
            if(state.currentPair.length >= 1) {
                document.getElementById('bat1').innerText = state.currentPair[0].name + (state.strikerIdx===0 ? " *" : "");
                document.getElementById('bat1').className = (state.strikerIdx===0 ? "active-bat" : "");
                if(state.currentPair[1]) {
                    document.getElementById('bat2').innerText = state.currentPair[1].name + (state.strikerIdx===1 ? " *" : "");
                    document.getElementById('bat2').className = (state.strikerIdx===1 ? "active-bat" : "");
                }
            }
            document.getElementById('bowlerName').innerText = state.currentBowler ? state.currentBowler.name : "-";
            if(match.inning === 2) document.getElementById('needVal').innerText = Math.max(0, match.target - state.score);
            let dHTML = ""; for(let i=0; i<state.dots; i++) dHTML += "ðŸ”´ "; for(let i=state.dots; i<3; i++) dHTML += "âšª ";
            document.getElementById('dotTracker').innerHTML = dHTML;
            if(state.balls >= 42) document.getElementById('scoreCard').classList.add('death-active');
            else document.getElementById('scoreCard').classList.remove('death-active');
        }

        function endInnings() {
            if(match.inning === 1) {
                match.firstScore = state.score; match.target = state.score + 1;
                document.getElementById('innScore').innerText = state.score;
                document.getElementById('innTarget').innerText = "Target: " + match.target;
                document.getElementById('overlayInnings').classList.remove('hidden');
            } else showFinalSummary();
        }

        function calculateSR(r, b) { return b > 0 ? ((r / b) * 100).toFixed(2) : "0.00"; }

        function showFinalSummary() {
            const b = document.getElementById('summaryBody'); b.innerHTML = "";
            let res = state.score >= match.target ? teams.t2.name + " WINS!" : (state.score === match.firstScore ? "MATCH TIED!" : teams.t1.name + " WINS!");
            document.getElementById('finalResultText').innerText = res;
            document.getElementById('finalScoreText').innerText = `${teams.t1.name}: ${match.firstScore} | ${teams.t2.name}: ${state.score}`;
            
            [...teams.t1.p, ...teams.t2.p].forEach(p => {
                const s = state.stats[p.name];
                const sr = calculateSR(s.r, s.b);
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="text-left">${p.name}</td><td>${s.r}</td><td>${s.b}</td><td>${sr}</td><td>${s.w}</td>`;
                b.appendChild(tr);
            });
            document.getElementById('overlaySummary').classList.remove('hidden');
        }

        function shareResult() {
            let text = `ðŸ *Cric-8 Match Result* ðŸ\n\n${teams.t1.name}: ${match.firstScore}\n${teams.t2.name}: ${state.score}\n\n*Result:* ${document.getElementById('finalResultText').innerText}\n\n*Player Stats:*`;
            [...teams.t1.p, ...teams.t2.p].forEach(p => {
                const s = state.stats[p.name];
                const sr = calculateSR(s.r, s.b);
                text += `\n- ${p.name}: ${s.r} runs (${s.b}b) | SR: ${sr} | ${s.w} wkts`;
            });
            navigator.clipboard.writeText(text).then(() => alert("Full Scorecard with SR copied!"));
        }

        function startSecondInnings() {
            document.getElementById('overlayInnings').classList.add('hidden');
            match.inning = 2; let t = match.battingTeamId; match.battingTeamId = match.bowlingTeamId; match.bowlingTeamId = t;
            startInningsLogic();
        }

        function setStrike(i) { state.strikerIdx = i; updateUI(); }
        function swapStrike() { state.strikerIdx = state.strikerIdx === 0 ? 1 : 0; state.dots = 0; }
        function undo() { if(match.history.length > 0) { state = match.history.pop(); updateUI(); } }
    </script>
</body>
</html>
