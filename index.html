<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cric-8 Tournament Pro</title>
    <style>
        body { font-family: -apple-system, system-ui, sans-serif; background: #0f172a; color: white; text-align: center; padding: 10px; margin: 0; touch-action: manipulation; overflow-x: hidden; }
        .hidden { display: none !important; }
        .screen { max-width: 500px; margin: auto; padding-bottom: 50px; }
        
        #toast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: #10b981; color: white; padding: 15px 25px; border-radius: 12px; font-weight: bold; z-index: 1000; transition: top 0.4s; }
        #toast.show { top: 20px; }

        input { padding: 12px; margin: 5px; width: 90%; border-radius: 8px; border: 1px solid #334155; background: #1e293b; color: white; }
        .score-card { background: #1e293b; padding: 15px; border-radius: 15px; border: 1px solid #334155; }
        .score-big { font-size: 4.5rem; font-weight: 800; color: #38bdf8; line-height: 1; }
        
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        button { padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.1s; }
        button:active { transform: scale(0.98); }
        .btn-run { background: #334155; color: white; }
        .btn-wkt { background: #ef4444; color: white; grid-column: span 3; }
        .btn-xtra { background: #f59e0b; color: black; }
        
        .overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.98); display: flex; flex-direction: column; align-items: center; z-index: 200; overflow-y: auto; padding: 20px; }
        .sel-btn { background: #38bdf8; color: #0f172a; padding: 15px; border-radius: 8px; font-weight: bold; width: 100%; margin: 5px 0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 0.75rem; background: #1e293b; border-radius: 10px; }
        th { background: #334155; color: #38bdf8; padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #334155; }
        
        .award-card { background: #1e293b; border: 1px solid #fbbf24; padding: 10px; border-radius: 10px; margin: 5px 0; width: 90%; display: flex; justify-content: space-between; align-items: center; }
        .award-title { font-size: 0.7rem; color: #fbbf24; text-transform: uppercase; letter-spacing: 1px; }
        .active-bat { color: #fbbf24; font-weight: 900; }
    </style>
</head>
<body onload="checkSave()">

    <div id="toast">Message</div>

    <div id="overlayLeague" class="overlay hidden">
        <h2 style="color:#38bdf8; margin-top: 20px;">TOURNAMENT HUB</h2>
        
        <div id="awardsSection" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
            <div class="award-card"><div><div class="award-title">üèÜ Player of Tournament</div><b id="potName">-</b></div><span id="potVal">0 pts</span></div>
            <div class="award-card" style="border-color: #f97316;"><div><div class="award-title">üèè Orange Cap (Most Runs)</div><b id="orangeName">-</b></div><span id="orangeVal">0</span></div>
            <div class="award-card" style="border-color: #a855f7;"><div><div class="award-title">üß∂ Purple Cap (Most Wickets)</div><b id="purpleName">-</b></div><span id="purpleVal">0</span></div>
        </div>

        <table id="leagueTable">
            <thead><tr><th>Team</th><th>P</th><th>W</th><th>L</th><th>Pts</th></tr></thead>
            <tbody id="leagueBody"></tbody>
        </table>
        
        <button onclick="document.getElementById('overlayLeague').classList.add('hidden')" style="background:#475569; color:white; width:90%; margin-top:20px;">BACK TO GAME</button>
        <button onclick="resetLeague()" style="background:#7f1d1d; color:#fca5a5; width:90%; margin-top:10px; font-size: 0.8rem;">RESET FULL SEASON</button>
    </div>

    <div id="overlaySelect" class="overlay hidden"><h2 id="selTitle"></h2><div id="selGrid" style="width:100%; max-width:400px;"></div></div>
    
    <div id="overlayInnings" class="overlay hidden">
        <h2 style="color:#fbbf24; margin-top: 80px;">INNINGS COMPLETE</h2>
        <h1 id="innScore" style="font-size: 4rem;">0</h1>
        <button onclick="startSecondInnings()" style="background:#38bdf8; color:black; padding:20px; width:80%;">START 2ND INNINGS</button>
    </div>

    <div id="overlaySummary" class="overlay hidden">
        <h2 id="finalResultText">MATCH OVER</h2>
        <table style="width:90%"><thead><tr><th>Player</th><th>R</th><th>B</th><th>W</th></tr></thead><tbody id="summaryBody"></tbody></table>
        <button onclick="resetMatch()" style="background:#ef4444; color:white; padding:15px; width:90%; margin: 20px 0;">START NEW MATCH</button>
        <button onclick="showLeague()" style="background:#38bdf8; color:black; padding:15px; width:90%;">VIEW TOURNAMENT HUB</button>
    </div>

    <div id="screenSetup" class="screen">
        <h1 style="color:#38bdf8">Cric-8 Pro</h1>
        <input id="team1Name" placeholder="Team 1 Name">
        <input id="team2Name" placeholder="Team 2 Name">
        <div style="display:flex; gap:5px;"><div id="inputsT1" style="width:50%"></div><div id="inputsT2" style="width:50%"></div></div>
        <button onclick="initMatch()" style="background:#10b981; color:white; width:95%; margin-top:20px; padding: 15px;">START MATCH</button>
        <button onclick="showLeague()" style="background:#334155; color:white; width:95%; margin-top:10px; padding: 10px;">VIEW STANDINGS</button>
    </div>

    <div id="screenGame" class="screen hidden">
        <div id="batTeamName" style="color:#38bdf8; font-weight:bold;">-</div>
        <div style="display:flex; justify-content:space-around; background:#1e293b; padding:15px; border-radius:15px; margin: 10px 0;">
            <div id="bat1" onclick="setStrike(0)">-</div><div id="bat2" onclick="setStrike(1)">-</div>
        </div>
        <div class="score-card">
            <div id="scoreDisplay" class="score-big">0</div>
            <span>Overs: <span id="overDisplay">0.0</span>/8.0 | Wkts: <span id="wktDisplay">0</span></span>
        </div>
        <div class="grid" style="margin-top:15px;">
            <button class="btn-run" onclick="handleInput(0)">0</button><button class="btn-run" onclick="handleInput(1)">1</button>
            <button class="btn-run" onclick="handleInput(2)">2</button><button class="btn-run" onclick="handleInput(3)">3</button>
            <button class="btn-run" onclick="handleInput(4)">4</button><button class="btn-run" onclick="handleInput(6)">6</button>
            <button class="btn-wkt" onclick="handleInput('W')">WICKET (-5)</button>
            <button class="btn-xtra" onclick="handleInput('WD')">WD+2</button>
            <button class="btn-xtra" onclick="handleInput('NB')">NB+2</button>
        </div>
    </div>

    <script>
        let teams = { t1: {name:"", p:[]}, t2: {name:"", p:[]} };
        let match = { inning: 1, battingTeamId: 't1', bowlingTeamId: 't2', firstScore: 0 };
        let state = { score: 0, balls: 0, wickets: 0, strikerIdx: 0, currentPair: [], currentBowler: null, stats: {} };
        
        // PERSISTENT LEAGUE DATA
        let league = JSON.parse(localStorage.getItem('cric8_league')) || {};
        let playerStats = JSON.parse(localStorage.getItem('cric8_player_stats')) || {};

        for(let i=0; i<10; i++) {
            document.getElementById('inputsT1').innerHTML += `<input id="t1p${i}" placeholder="P${i+1}">`;
            document.getElementById('inputsT2').innerHTML += `<input id="t2p${i}" placeholder="P${i+1}">`;
        }

        function showToast(msg) {
            const t = document.getElementById('toast'); t.innerText = msg;
            t.className = 'show'; setTimeout(() => t.className = '', 2500);
        }

        function initMatch() {
            teams.t1.name = document.getElementById('team1Name').value || "Team 1";
            teams.t2.name = document.getElementById('team2Name').value || "Team 2";
            [teams.t1, teams.t2].forEach(t => { if(!league[t.name]) league[t.name] = {p:0, w:0, l:0, pts:0}; });
            for(let i=0; i<10; i++) {
                let n1 = document.getElementById(`t1p${i}`).value || `T1-P${i+1}`;
                let n2 = document.getElementById(`t2p${i}`).value || `T2-P${i+1}`;
                teams.t1.p.push({name: n1, batted:false, overs:0});
                teams.t2.p.push({name: n2, batted:false, overs:0});
                state.stats[n1] = {r:0, b:0, w:0}; state.stats[n2] = {r:0, b:0, w:0};
                if(!playerStats[n1]) playerStats[n1] = {r:0, w:0};
                if(!playerStats[n2]) playerStats[n2] = {r:0, w:0};
            }
            document.getElementById('screenSetup').classList.add('hidden');
            document.getElementById('screenGame').classList.remove('hidden');
            startInningsLogic();
        }

        function startInningsLogic() {
            state.score = 0; state.balls = 0; state.wickets = 0;
            state.strikerIdx = 0; state.currentPair = []; state.currentBowler = null;
            document.getElementById('batTeamName').innerText = teams[match.battingTeamId].name + " Batting";
            triggerSelectionProcess();
        }

        function triggerSelectionProcess() {
            if (state.currentPair.length < 2) pickBatters();
            else if (state.currentBowler === null) pickBowler();
            else updateUI();
        }

        function pickBatters() {
            const roster = teams[match.battingTeamId].p.filter(p => !p.batted);
            if (roster.length === 0) { endInnings(); return; }
            showOverlay("Select Striker", roster, (p1) => {
                p1.batted = true;
                const rem = roster.filter(x => x.name !== p1.name);
                showOverlay("Select Non-Striker", rem, (p2) => { p2.batted = true; state.currentPair = [p1, p2]; triggerSelectionProcess(); });
            });
        }

        function pickBowler() {
            const roster = teams[match.bowlingTeamId].p.filter(p => p.overs < 1);
            showOverlay("Select Bowler", roster, (p) => { state.currentBowler = p; triggerSelectionProcess(); });
        }

        function showOverlay(title, list, callback) {
            document.getElementById('selTitle').innerText = title;
            const grid = document.getElementById('selGrid'); grid.innerHTML = "";
            list.forEach(p => {
                const btn = document.createElement('button'); btn.className = 'sel-btn';
                btn.innerText = p.name; btn.onclick = () => { document.getElementById('overlaySelect').classList.add('hidden'); callback(p); saveGame(); };
                grid.appendChild(btn);
            });
            document.getElementById('overlaySelect').classList.remove('hidden');
        }

        function handleInput(type) {
            if(!state.currentBowler) return;
            const striker = state.currentPair[state.strikerIdx];
            if (typeof type === 'number') {
                state.score += type; state.stats[striker.name].r += type; state.stats[striker.name].b += 1; state.balls += 1;
                if(type % 2 !== 0) swapStrike();
            } else if (type === 'W') {
                state.score -= 5; state.stats[striker.name].r -= 5; state.stats[striker.name].b += 1; state.wickets += 1; state.balls += 1;
                state.stats[state.currentBowler.name].w += 1;
            } else if (type === 'WD' || type === 'NB') {
                state.score += 2; if (state.balls < 42) { state.balls += 1; state.stats[striker.name].b += 1; }
            }
            if (state.balls > 0 && state.balls % 6 === 0) {
                swapStrike(); state.currentBowler.overs += 1; state.currentBowler = null;
                if (state.balls >= 48) { endInnings(); return; }
                if (state.balls % 12 === 0) state.currentPair = [];
                triggerSelectionProcess();
            } else { updateUI(); saveGame(); }
        }

        function endInnings() {
            if(match.inning === 1) {
                match.firstScore = state.score; document.getElementById('innScore').innerText = state.score;
                document.getElementById('overlayInnings').classList.remove('hidden');
            } else finishMatch();
        }

        function finishMatch() {
            const t1 = teams.t1.name; const t2 = teams.t2.name;
            league[t1].p++; league[t2].p++;
            if(state.score > match.firstScore) { league[t2].w++; league[t2].pts += 2; league[t1].l++; }
            else { league[t1].w++; league[t1].pts += 2; league[t2].l++; }

            // UPDATE PLAYER GLOBAL STATS
            Object.keys(state.stats).forEach(name => {
                playerStats[name].r += state.stats[name].r;
                playerStats[name].w += state.stats[name].w;
            });

            localStorage.setItem('cric8_league', JSON.stringify(league));
            localStorage.setItem('cric8_player_stats', JSON.stringify(playerStats));
            showFinalSummary();
        }

        function showLeague() {
            const body = document.getElementById('leagueBody'); body.innerHTML = "";
            Object.keys(league).sort((a,b) => league[b].pts - league[a].pts).forEach(name => {
                const t = league[name]; body.innerHTML += `<tr><td>${name}</td><td>${t.p}</td><td>${t.w}</td><td>${t.l}</td><td>${t.pts}</td></tr>`;
            });

            // Calculate Awards
            let pot = {name: "-", val: -999}, orange = {name: "-", val: -999}, purple = {name: "-", val: -999};
            Object.keys(playerStats).forEach(name => {
                const p = playerStats[name];
                const points = p.r + (p.w * 10);
                if(points > pot.val) { pot = {name, val: points}; }
                if(p.r > orange.val) { orange = {name, val: p.r}; }
                if(p.w > purple.val) { purple = {name, val: p.w}; }
            });

            document.getElementById('potName').innerText = pot.name; document.getElementById('potVal').innerText = pot.val + " pts";
            document.getElementById('orangeName').innerText = orange.name; document.getElementById('orangeVal').innerText = orange.val + " runs";
            document.getElementById('purpleName').innerText = purple.name; document.getElementById('purpleVal').innerText = purple.val + " wkts";
            
            document.getElementById('overlayLeague').classList.remove('hidden');
        }

        function showFinalSummary() {
            document.getElementById('overlaySummary').classList.remove('hidden');
            const b = document.getElementById('summaryBody'); b.innerHTML = "";
            [...teams.t1.p, ...teams.t2.p].forEach(p => {
                const s = state.stats[p.name];
                if(s.b > 0 || s.w > 0) b.innerHTML += `<tr><td>${p.name}</td><td>${s.r}</td><td>${s.b}</td><td>${s.w}</td></tr>`;
            });
        }

        function saveGame() { localStorage.setItem('cric8_state', JSON.stringify({teams, match, state})); }
        function checkSave() { if(localStorage.getItem('cric8_state')) { const d = JSON.parse(localStorage.getItem('cric8_state')); teams=d.teams; match=d.match; state=d.state; document.getElementById('screenSetup').classList.add('hidden'); document.getElementById('screenGame').classList.remove('hidden'); updateUI(); } }
        function updateUI() { document.getElementById('scoreDisplay').innerText = state.score; document.getElementById('overDisplay').innerText = `${Math.floor(state.balls/6)}.${state.balls%6}`; document.getElementById('wktDisplay').innerText = state.wickets; if(state.currentPair[0]) document.getElementById('bat1').innerText = state.currentPair[0].name + (state.strikerIdx===0?"*":""); if(state.currentPair[1]) document.getElementById('bat2').innerText = state.currentPair[1].name + (state.strikerIdx===1?"*":""); }
        function setStrike(i) { state.strikerIdx = i; updateUI(); }
        function swapStrike() { state.strikerIdx = state.strikerIdx === 0 ? 1 : 0; }
        function startSecondInnings() { document.getElementById('overlayInnings').classList.add('hidden'); match.inning = 2; let t = match.battingTeamId; match.battingTeamId = match.bowlingTeamId; match.bowlingTeamId = t; startInningsLogic(); }
        function resetMatch() { localStorage.removeItem('cric8_state'); location.reload(); }
        function resetLeague() { if(confirm("Wipe all season stats and player awards?")) { localStorage.clear(); location.reload(); } }
    </script>
</body>
</html>
